# 도커 컴포즈로 분산 애플리케이션 실행하기

- Dockerfile 스크립트는 애플리케이션의 한 부분을 패키징하는 수단이다.
- 이들 컨테이너를 실행하려면 도커 컴포즈 파일에 애플리케이션의 구조를 정의하면 된다.

## 도커 컴포즈 파일

- 애플리케이션의 원하는 상태 (모든 컴포넌트가 실행 중일 때 어떤 상태여야 하는지를 기술하는 파일)
- 또한 docker container run 명령으로 컨테이너를 실행할때 지정하는 모든 옵션을 한데 모아 놓은 단순한 형식의 파일
- 도커 컴포즈를 작성하고 나면 도커 컴포즈 도구를 사용해 애플리케이션을 실행한다.
- 도커 컴포즈가 컨테이너, 네트워크, 볼륨 등 필요한 모든 도커 객체를 만들도록 도커 API에 명령을 내린다.
- yaml 문법으로 기술된다.

```yaml
// 도커 컴포즈 파일 형식의 버전을 가리킨다.
version: '3.7'

// 애플리케이션을 구성하는 모든 컴포넌트를 열거하는 부분.
// 실제 컨테이너 대신 서비스 개념을 단위로 삼는다.
// 하나의 서비스를 같은 이미지로 여러 컨테이너에서 실행할 수 있기 때문이다.
services:
  todo-web:
    image: diamol/ch06-todo-list
    ports:
      - '8020:80'
    networks:
      - app-net

// 서비스 컨테이너가 연결될 모든 도커 네트워크를 열거하는 부분
networks:
  app-net:
    // nat 네트워크가 이미 존재하므로 새로 생성하지 말라는 뜻
    external:
      name: nat
```

서비스 이름은 컨테이너의 이름이자 도커 네트워크상에서 다른 컨테이너들이 해당 컨테이너를 식별하기 위한 DNS네임 으로 쓰인다.

```sh
// 도커 네트워크 생성
docker network create nat

// 애플리케이션을 시작한다.
docker-compose up

```

- docker-compose 명령을 실행하면 먼저 현재 작업 디렉터리에서 docker-compose.yml 파일을 찾는다.
- 해당 파일을 발견하면 to-do 애플리케이션의 정의를 읽어 들인다.
- 현재는 todo-web 서비스를 구성하는 컨테이너가 하나도 없으므로 도커 컴포즈가 컨테이너를 하나 실행한다.

도커 컴포즈 파일에 애플리케이션의 모든 실행 옵션이 기술된다.
그러므로 README 파일에 애플리케이션 이미지 이름이나 공개할 포트 번호를 문서화할 필요가 없다.

## 7.3 도커 컨테이너 간의 통신

- 컨테이너는 별도의 네트워크 공간을 가진 가상환경
- 도커 엔진으로부터 부여받은 자신만의 가상 IP 주소를 가지며 모두 같은 도커 네트워크로 연결돼 이 IP 주소를 통해 서로 통신할 수 있다.
- 그러나 애플리케이션 생애주기 동안에 컨테이너가 교체되면 이 IP 주소도 변경된다.
- IP 주소가 변경돼도 문제 없도록 도커에서 DNS를 이용해 서비스 디스커버리 기능을 제공한다.

만약 도메인이 가리키는 대상이 컨테이너가 아니면 도커 엔진을 실행 중인 컴퓨터에 요청을 보내 호스트 컴퓨터가 속한 네트워크나 인터넷의 IP 주소를 조회 한다.

```sh
# cmd에서 인터렉티브 셸 실행
docker container exec -it image-of-the-day-image-gallery-1 sh

# nslookup은 웹 애플리케이션 컨테이너의 기반 이미지에 들어 있는 유틸리트다.
# 명령의 인자로 도메인을 지정하면 해당 도메인을 DNS 서비스에서 조회하고 그 결과를 출력한다.
# accesslog 서비스를 DNS에 조회해 보면 해당 컨테이너의 IP 주소가 조회 된다.
# accesslog 컨테이너의 IP 주소를 확인할 수 있다.
nslookup accesslog
```

도커 네트워크에 연결된 모든 컨테이너는 이 네트워크의 범위에 포함되는 IP 주소를 부여받는다.
그리고 이 네트워크를 통해 컨테이너 간 통신이 가능하다.

DNS 조회를 사용하면 컨테이너가 교체돼 IP 주소가 변경되더라도 항상 새로 만들어진 컨테이너에 접근할 수 있다.

하나의 도메인에 대해 DNS 조회 결과에 여러 개의 IP 주소가 나올 수 있다. 도커 컴포즈는 이 점을 활용해 간단한 로드 밸런싱을 구현할 수 있다.
여러 개의 IP 주소가 담긴 조회 결과를 어떻게 활용할지는 전적으로 애플리케이션이 담당한다.

도커 컴포즈는 컨테이너를 실행할 때 지정하는 모든 옵션값을 기억한다.
이들 옵션값을 통해 컨테이너 간의 통신을 처리한다.

## 7.4 도커 컴포즈로 애플리케이션 설정값 지정하기

```yml
version: '3.7'

services:
  todo-db:
    image: diamol/postgres:11.5
    ports:
      - '5433:5432'
    networks:
      - app-net

  todo-web:
    image: diamol/ch06-todo-list
    ports:
      - '8030:80'
    # 컨테이너 안에서 사용될 환경 변수 값이 정의된다.
    environment:
      - Database:Provider=Postgres
    depends_on:
      - todo-db
    networks:
      - app-net
    # 실행 시 컨테이너 내부의 파일에 기록될 비밀값을 정의한다.
    # 애플리케이션이 실행되면 컨테이너에 /app/config/secrets.json 파일이 생기고
    # 이 파일에는 postgres-connection이라는 이름의 비밀값의 값이 기록된다.
    secrets:
      - source: postgres-connection
        target: /app/config/secrets.json

networks:
  app-net:

# 비밀값 postgres-connection의 값을 secrets.json 파일에서 읽어 오라는 의미
secrets:
  postgres-connection:
    file: ./config/secrets.json
```

비밀값은 주로 클러스터 환경에서 쿠버네티스나 도커 스웜 같은 컨테이너 플랫폼을 통해 제공된다.
평소에는 클러스터 테이더베이스에 암호화돼 있기 때문에 데이터베이스 패스워드, 인증서, API 키 등 민감한 정보로 구성된 설정값을 전달하는 데 적합하다. 도커를 단일 컴퓨터에서 실행하는 상황이라면 비밀값을 보관하는 클러스터 데이터베이스가 없을 것이므로 파일을 통해 비밀값을 전달해도 된다.

**클러스터 란**

- 사전적 정의: 집합, 군집
- 하나의 데이터베이스를 여러개의 서버로 구축되는 경우를 클러스터(Cluster)라고 지칭한다.

데이터베이스 클러스터의 조건을 만족시키기 위한 3요소

- 고가용성
- 병렬처리
- 성능향상

```sh
# 컴포즈 파일에 정의된 모든 컨테이너의 목록을 보여 준다.
docker-compose ps
```

패키징된 애플리케이션과 설정값을 분리할 수 있다는 것도 도커의 장점 중 하나다.
